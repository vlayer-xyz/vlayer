name: Download Vouch Browser Extension latest release
description: Download the latest release of the Vouch Browser Extension.
inputs:
  VOUCH_EXTENSION_DOWNLOAD_PAT:
    required: true
    description: 'Token to download the Browser Extension release from Vouch.'
runs:
  using: "composite"
  steps:
    - name: Download Vouch Browser Extension latest release
      working-directory: ./packages/browser-extension
      shell: bash
      env:
        VOUCH_EXTENSION_DOWNLOAD_PAT: ${{ inputs.VOUCH_EXTENSION_DOWNLOAD_PAT }}
      run: |
        RELEASE_JSON=$(curl -s -L \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${VOUCH_EXTENSION_DOWNLOAD_PAT}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "https://api.github.com/repos/vlayer-xyz/vouch/releases/tags/browser-extension-latest")

        ASSET_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name == "browser-extension.tar.gz") | .url')
        echo "Asset URL: $ASSET_URL"

        curl -L \
          -H "Accept: application/octet-stream" \
          -H "Authorization: Bearer ${VOUCH_EXTENSION_DOWNLOAD_PAT}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "$ASSET_URL" \
          --output browser-extension.tar.gz

        mkdir -p dist
        tar -xzf browser-extension.tar.gz -C dist --strip-components=4

    - name: Diaplay dist working-directory
      working-directory: ./packages/browser-extension/dist
      shell: bash
      run: ls
        
    - name: Clean up tarball
      working-directory: ./packages/browser-extension
      shell: bash
      run: rm browser-extension.tar.gz
