# Auto-updates the development Prover server with a latest nightly vlayer release,
# after a successful release.
name: Update Prover Server
on: 
  workflow_run:
    workflows: ["Release binaries"]
    types: [completed]
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false
jobs:
  update-prover-server:
    name: Update Prover server
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    defaults:
      run:
        working-directory: ansible
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Add deployer ssh key and run the Ansible playbook
        run: |
          eval "$(ssh-agent -s)"
          ssh-add - <<< "${{ secrets.DEVELOPMENT_DEPLOYER_SSH_KEY }}"

          ansible-playbook -i hosts.yml --limit "dev_prover" prover.yml \
            --vault-password-file <(echo '${{ secrets.ANSIBLE_DEVELOPMENT_VAULT_PASSWORD }}')
      - name: Clean up manually added ssh keys
        if: always()
        run: |
          eval "$(ssh-agent -s)"
          ssh-add -D
