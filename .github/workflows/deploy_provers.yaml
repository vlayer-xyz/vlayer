# Auto-updates the Prover servers with a latest nightly vlayer release,
# after a successful release.
name: Deploy Provers
on:
  workflow_run:
    workflows: ["Release nightly"]
    types: [completed]
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false
jobs:
  deploy-provers:
    name: Deploy Provers
    environment: Production
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    defaults:
      run:
        working-directory: ansible
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install ansible galaxy collections
        run: |
          ansible-galaxy collection install -r requirements.yml
          ansible-galaxy role install -r requirements.yml
      - name: Deploy nightly prover
        if: ${{ github.event.workflow_run.workflow_name == 'Release nightly' }}
        run: |
          eval "$(ssh-agent -s)"
          ssh-add - <<< "${{ secrets.PRODUCTION_DEPLOYER_SSH_KEY }}"

          ansible-playbook -i hosts.yml prover.yml --limit "nightly_fake_prover" \
            --vault-password-file <(echo '${{ secrets.ANSIBLE_PRODUCTION_VAULT_PASSWORD }}')
      - name: Deploy stable prover
        if: ${{ github.event.workflow_run.workflow_name == 'Release stable' }}
        run: |
          eval "$(ssh-agent -s)"
          ssh-add - <<< "${{ secrets.PRODUCTION_DEPLOYER_SSH_KEY }}"

          ansible-playbook -i hosts.yml prover.yml --limit "stable_fake_prover" \
            --vault-password-file <(echo '${{ secrets.ANSIBLE_PRODUCTION_VAULT_PASSWORD }}')
      - name: Clean up manually added ssh keys
        if: always()
        run: |
          eval "$(ssh-agent -s)"
          ssh-add -D
