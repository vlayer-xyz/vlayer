# Updates the chain services.
# Uses a built binary, because chain service binaries are not released (yet).
name: Deploy Chain Services
on:
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false
jobs:
  deploy-chain-services:
    name: Deploy Chain Services
    environment: Production
    defaults:
      run:
        working-directory: ansible
    runs-on: aws-linux-medium
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Rust prerequisites
        uses: ./.github/actions/rust-prerequisites
      - name: Install contracts prerequisites
        uses: ./.github/actions/contracts-prerequisites
      - name: Install Ansible
        uses: alex-oleshkevich/setup-ansible@b77f1a5e01dbcf520c28b545fa37c8f022c1803a
        with:
          version: "11.2.0"

      # Needed until we have those binaries released.
      - name: Build chain service binaries
        env:
          VLAYER_RELEASE: "nightly"
          RISC0_USE_DOCKER: 1
        run: cargo build --release --bin worker --bin chain_server
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: chain-service-binaries
          path: |
            target/release/worker
            target/release/chain_server
          retention-days: 2

      - name: Install ansible galaxy collections
        run: |
          ansible-galaxy collection install -r requirements.yml
          ansible-galaxy role install -r requirements.yml
      - name: Add deployer ssh key and run the Ansible playbook
        run: |
          eval "$(ssh-agent -s)"
          ssh-add - <<< "${{ secrets.PRODUCTION_DEPLOYER_SSH_KEY }}"

          ansible-playbook -i hosts.yml chain_service.yml \
            --vault-password-file <(echo '${{ secrets.ANSIBLE_PRODUCTION_VAULT_PASSWORD }}')
      - name: Clean up manually added ssh keys
        if: always()
        run: |
          eval "$(ssh-agent -s)"
          ssh-add -D
