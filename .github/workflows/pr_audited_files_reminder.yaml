name: Audited files reminder

on:
  pull_request:

jobs:
  check-audit-files:
    name: Check Audited Files Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for audited files changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            audited-files:
              # Audited files - 07 February 2025 - a76361451c47dbef25db03f61d2b0e26e0c5d940
              - 'rust/guest_wrapper/risc0_call_guest/Cargo.lock'
              - 'rust/guest_wrapper/risc0_chain_guest/Cargo.lock'
              - 'contracts/vlayer/foundry.toml'
              - 'contracts/vlayer/src/CallAssumptions.sol'
              - 'contracts/vlayer/src/EmailProof.sol'
              - 'contracts/vlayer/src/PrecompilesAddresses.sol'
              - 'contracts/vlayer/src/Proof.sol'
              - 'contracts/vlayer/src/Prover.sol'
              - 'contracts/vlayer/src/Regex.sol'
              - 'contracts/vlayer/src/Repository.sol'
              - 'contracts/vlayer/src/Seal.sol'
              - 'contracts/vlayer/src/TestnetStableDeployment.sol'
              - 'contracts/vlayer/src/Url.sol'
              - 'contracts/vlayer/src/Verifier.sol'
              - 'contracts/vlayer/src/WebProof.sol'
              - 'contracts/vlayer/src/proof_verifier/ChainId.sol'
              - 'contracts/vlayer/src/proof_verifier/Groth16ProofVerifier.sol'
              - 'contracts/vlayer/src/proof_verifier/IProofVerifier.sol'
              - 'contracts/vlayer/src/proof_verifier/ProofVerifierBase.sol'
              - 'rust/block_header/Cargo.toml'
              - 'rust/block_header/src/casting_utils.rs'
              - 'rust/block_header/src/eth.rs'
              - 'rust/block_header/src/forge.rs'
              - 'rust/block_header/src/lib.rs'
              - 'rust/chain/Cargo.toml'
              - 'rust/chain/chain_specs.toml'
              - 'rust/chain/src/config.rs'
              - 'rust/chain/src/eip1559.rs'
              - 'rust/chain/src/fork.rs'
              - 'rust/chain/src/lib.rs'
              - 'rust/chain/src/optimism.rs'
              - 'rust/chain/src/spec.rs'
              - 'rust/common/Cargo.toml'
              - 'rust/common/src/cache.rs'
              - 'rust/common/src/guest.rs'
              - 'rust/common/src/hashable.rs'
              - 'rust/common/src/lib.rs'
              - 'rust/common/src/verifier/sealing.rs'
              - 'rust/common/src/verifier/zk_proof.rs'
              - 'rust/common/src/verifier.rs'
              - 'rust/email_proof/Cargo.toml'
              - 'rust/email_proof/src/dkim.rs'
              - 'rust/email_proof/src/dns.rs'
              - 'rust/email_proof/src/email/sol.rs'
              - 'rust/email_proof/src/email.rs'
              - 'rust/email_proof/src/email_address.rs'
              - 'rust/email_proof/src/errors.rs'
              - 'rust/email_proof/src/from_header.rs'
              - 'rust/email_proof/src/lib.rs'
              - 'rust/guest_wrapper/Cargo.toml'
              - 'rust/guest_wrapper/build.rs'
              - 'rust/guest_wrapper/build_utils/Cargo.toml'
              - 'rust/guest_wrapper/build_utils/src/chain_guest_id.rs'
              - 'rust/guest_wrapper/build_utils/src/data_layout.rs'
              - 'rust/guest_wrapper/build_utils/src/lib.rs'
              - 'rust/guest_wrapper/build_utils/src/risc0_builder.rs'
              - 'rust/guest_wrapper/risc0_call_guest/Cargo.toml'
              - 'rust/guest_wrapper/risc0_call_guest/build.rs'
              - 'rust/guest_wrapper/risc0_call_guest/src/main.rs'
              - 'rust/guest_wrapper/risc0_chain_guest/Cargo.toml'
              - 'rust/guest_wrapper/risc0_chain_guest/build.rs'
              - 'rust/guest_wrapper/risc0_chain_guest/src/main.rs'
              - 'rust/guest_wrapper/src/lib.rs'
              - 'rust/mpt/Cargo.toml'
              - 'rust/mpt/src/hash.rs'
              - 'rust/mpt/src/key_nibbles.rs'
              - 'rust/mpt/src/lib.rs'
              - 'rust/mpt/src/node/constructors.rs'
              - 'rust/mpt/src/node/insert/entry.rs'
              - 'rust/mpt/src/node/insert/from_two_entries.rs'
              - 'rust/mpt/src/node/insert/insert_entry_into_branch.rs'
              - 'rust/mpt/src/node/insert/insert_entry_into_extension/from_extension_and_entry_empty_common_prefix.rs'
              - 'rust/mpt/src/node/insert/insert_entry_into_extension.rs'
              - 'rust/mpt/src/node/insert/utils.rs'
              - 'rust/mpt/src/node/insert.rs'
              - 'rust/mpt/src/node/rlp.rs'
              - 'rust/mpt/src/node/size.rs'
              - 'rust/mpt/src/node.rs'
              - 'rust/mpt/src/node_ref.rs'
              - 'rust/mpt/src/path.rs'
              - 'rust/mpt/src/trie/utils.rs'
              - 'rust/mpt/src/trie.rs'
              - 'rust/mpt/src/utils.rs'
              - 'rust/services/call/common/Cargo.toml'
              - 'rust/services/call/common/src/helpers.rs'
              - 'rust/services/call/common/src/lib.rs'
              - 'rust/services/call/common/src/location.rs'
              - 'rust/services/call/common/src/metadata.rs'
              - 'rust/services/call/engine/Cargo.toml'
              - 'rust/services/call/engine/src/config.rs'
              - 'rust/services/call/engine/src/consts.rs'
              - 'rust/services/call/engine/src/db.rs'
              - 'rust/services/call/engine/src/evm/env/cached.rs'
              - 'rust/services/call/engine/src/evm/env/factory.rs'
              - 'rust/services/call/engine/src/evm/env.rs'
              - 'rust/services/call/engine/src/evm/execution_result.rs'
              - 'rust/services/call/engine/src/evm/input.rs'
              - 'rust/services/call/engine/src/evm.rs'
              - 'rust/services/call/engine/src/io.rs'
              - 'rust/services/call/engine/src/lib.rs'
              - 'rust/services/call/engine/src/sol/call_assumptions.rs'
              - 'rust/services/call/engine/src/sol/proof.rs'
              - 'rust/services/call/engine/src/sol/seal.rs'
              - 'rust/services/call/engine/src/sol.rs'
              - 'rust/services/call/engine/src/travel_call/args.rs'
              - 'rust/services/call/engine/src/travel_call/error.rs'
              - 'rust/services/call/engine/src/travel_call/evm.rs'
              - 'rust/services/call/engine/src/travel_call/inspector.rs'
              - 'rust/services/call/engine/src/travel_call.rs'
              - 'rust/services/call/engine/src/utils/cache.rs'
              - 'rust/services/call/engine/src/utils/evm_call.rs'
              - 'rust/services/call/engine/src/utils.rs'
              - 'rust/services/call/engine/src/verifier/teleport.rs'
              - 'rust/services/call/engine/src/verifier/time_travel.rs'
              - 'rust/services/call/engine/src/verifier/travel_call.rs'
              - 'rust/services/call/engine/src/verifier.rs'
              - 'rust/services/call/guest/Cargo.toml'
              - 'rust/services/call/guest/src/db/state.rs'
              - 'rust/services/call/guest/src/db/wrap_state.rs'
              - 'rust/services/call/guest/src/db.rs'
              - 'rust/services/call/guest/src/guest/env.rs'
              - 'rust/services/call/guest/src/guest.rs'
              - 'rust/services/call/guest/src/lib.rs'
              - 'rust/services/call/optimism/Cargo.toml'
              - 'rust/services/call/optimism/src/anchor_state_registry.rs'
              - 'rust/services/call/optimism/src/client/cached.rs'
              - 'rust/services/call/optimism/src/client/factory/cached.rs'
              - 'rust/services/call/optimism/src/client/factory/http.rs'
              - 'rust/services/call/optimism/src/client/factory/recording.rs'
              - 'rust/services/call/optimism/src/client/factory.rs'
              - 'rust/services/call/optimism/src/client/http.rs'
              - 'rust/services/call/optimism/src/client/recording.rs'
              - 'rust/services/call/optimism/src/client.rs'
              - 'rust/services/call/optimism/src/lib.rs'
              - 'rust/services/call/optimism/src/types/rpc.rs'
              - 'rust/services/call/optimism/src/types.rs'
              - 'rust/services/call/precompiles/Cargo.toml'
              - 'rust/services/call/precompiles/src/email_proof.rs'
              - 'rust/services/call/precompiles/src/helpers.rs'
              - 'rust/services/call/precompiles/src/json.rs'
              - 'rust/services/call/precompiles/src/lib.rs'
              - 'rust/services/call/precompiles/src/precompile.rs'
              - 'rust/services/call/precompiles/src/regex.rs'
              - 'rust/services/call/precompiles/src/url_pattern.rs'
              - 'rust/services/call/precompiles/src/web_proof.rs'
              - 'rust/services/call/seal/Cargo.toml'
              - 'rust/services/call/seal/src/lib.rs'
              - 'rust/services/chain/block_trie/Cargo.toml'
              - 'rust/services/chain/block_trie/src/lib.rs'
              - 'rust/services/chain/common/Cargo.toml'
              - 'rust/services/chain/common/src/lib.rs'
              - 'rust/services/chain/common/src/verifier.rs'
              - 'rust/services/chain/guest/Cargo.toml'
              - 'rust/services/chain/guest/src/lib.rs'
              - 'rust/verifiable_dns/Cargo.toml'
              - 'rust/verifiable_dns/src/common/record.rs'
              - 'rust/verifiable_dns/src/common/to_payload.rs'
              - 'rust/verifiable_dns/src/common/types.rs'
              - 'rust/verifiable_dns/src/common.rs'
              - 'rust/verifiable_dns/src/dns_over_https.rs'
              - 'rust/verifiable_dns/src/lib.rs'
              - 'rust/verifiable_dns/src/verifiable_dns.rs'
              - 'rust/verifiable_dns/src/verifier/mod.rs'
              - 'rust/web_proof/Cargo.toml'
              - 'rust/web_proof/src/errors.rs'
              - 'rust/web_proof/src/fixtures/tlsn_core_types.rs'
              - 'rust/web_proof/src/fixtures.rs'
              - 'rust/web_proof/src/lib.rs'
              - 'rust/web_proof/src/redaction.rs'
              - 'rust/web_proof/src/request_transcript.rs'
              - 'rust/web_proof/src/response_transcript.rs'
              - 'rust/web_proof/src/transcript_parser.rs'
              - 'rust/web_proof/src/utils/bytes.rs'
              - 'rust/web_proof/src/utils/json.rs'
              - 'rust/web_proof/src/utils.rs'
              - 'rust/web_proof/src/verifier.rs'
              - 'rust/web_proof/src/web.rs'
              - 'rust/web_proof/src/web_proof.rs'

      - name: Add audit notification comment
        if: steps.filter.outputs.audited-files == 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: audit-files-changed
          message: |
            ⚠️ **Audited Files Changed**

            This PR modifies files that were included in the security audit.
            cc @marekkirejczyk

            **Required Actions:**
            - [ ] Review changes with the Protocol team (@vlayer-xyz/protocol)
            - [ ] Update the list of PRs for re-audit in Notion
      - name: Remove audit comment if no audited files changed
        if: steps.filter.outputs.audited-files != 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: audit-files-changed
          delete: true
