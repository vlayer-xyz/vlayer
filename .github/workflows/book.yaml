name: Book
on: [push, merge_group]

jobs:
  rust:
    runs-on: ubuntu-latest

    steps:
      - uses: cargo-bins/cargo-binstall@main

      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install mdbook
        working-directory: book
        run: |
          mkdir bin
          curl -sSL https://github.com/rust-lang/mdBook/releases/download/v0.4.40/mdbook-v0.4.40-x86_64-unknown-linux-gnu.tar.gz | tar -xz --directory=bin

      - name: Build book
        working-directory: book
        run: |
          bin/mdbook build

    - name: Deploy to Vercel
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      run: |
        npm install -g vercel
        # Determine the alias for the current branch or PR
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          ALIAS="pr-${{ github.event.number }}-$(echo ${{ github.head_ref }} | sed 's/\//-/g')"
        else
          ALIAS="$(echo ${{ github.ref }} | sed 's/refs\/heads\///' | sed 's/\//-/g')"
        fi
        
        vercel --prod --token $VERCEL_TOKEN --project-id $VERCEL_PROJECT_ID --org-id $VERCEL_ORG_ID --confirm --cwd ./book --scope $VERCEL_ORG_ID --alias $ALIAS
