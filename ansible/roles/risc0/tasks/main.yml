---
- name: Install Foundryup
  ansible.builtin.shell: |
    set -ueo pipefail
    curl -L https://foundry.paradigm.xyz | bash
  args:
    creates: ~/.foundry/bin/foundryup
    executable: /bin/bash
- name: Install Foundry
  ansible.builtin.shell: ~/.foundry/bin/foundryup
  args:
    executable: /bin/bash
    creates: ~/.foundry/bin/forge

- name: Install rustup
  ansible.builtin.shell: |
    set -ueo pipefail
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain stable -y
  args:
    executable: /bin/bash
    creates: .cargo/bin/rustup
- name: Install Cargo binstall
  ansible.builtin.shell: |
    set -ueo pipefail
    curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
  args:
    executable: /bin/bash
    creates: ~/.cargo/bin/cargo-binstall
- name: Check installed version of risc0
  ansible.builtin.shell: |
    set -ueo pipefail
    # Exit early if risc0 not installed at all
    ~/.cargo/bin/cargo install --list | grep -q cargo-risczero || exit 0
    # Capture installed version
    ~/.cargo/bin/cargo install --list | grep -oP 'cargo-risczero v\d+\.\d+\.\d+' | grep -oP '\d+\.\d+\.\d+'
  register: installed_risc0
  changed_when: false
  args:
    executable: /bin/bash
- name: Install risc0
  ansible.builtin.shell: |
    set -ueo pipefail
    ~/.cargo/bin/cargo binstall -y cargo-risczero@{{ vlayer_risc0_version }} --force
    ~/.cargo/bin/cargo risczero install
  when: vlayer_risc0_version != installed_risc0.stdout
  changed_when: vlayer_risc0_version != installed_risc0.stdout
  args:
    executable: /bin/bash
